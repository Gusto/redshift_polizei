<!-- TODO add analyze and vacuum option -->

<div style="overflow: auto;">
  <div style="float: left;"><h2 name="tables" id="tables">Tables <small class="secondary">(last update: <span id="last_update" class="abs_rel"></span>)</small></h2></div>
  <span id="last_update_store" style="display: none;"><%= (@updated.nil? ? 0 : @updated.utc.to_i) %></span>
  <div style="float: right;">
    <button type="button" class="btn btn-primary btn-default" style="margin-top: 25px;" id="update_all_tables">
      Check for new tables now
    </button>
    <%= img '/images/ajax-loader.gif', id: "update_all_tables_loading", height: '25px', style: 'padding: 0 15px; margin-top: 25px; margin-left: 5px; display: none;' %>
    <button type="button" class="btn btn-primary btn-default" data-toggle="modal" data-target="#export_structure_modal" style="margin-top: 25px;">
      Export all table schemas
    </button>
  </div>
</div>

<div class="modal fade" id="export_structure_modal" tabindex="-1" role="dialog" aria-labelledby="exportStructureLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form class="form-horizontal" role="form" method="POST" action="<%= url '/tables/structure_export' %>" style="margin-top: 10px;">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="exportStructureLabel">Export the schema of all tables</h4>
        </div>
        <div class="modal-body">
          <div id="error_alert" class="alert alert-danger" role="alert" style="display: none;"></div>
          This might take a while (a couple of minutes). We'll send you an E-Mail once we're done.<br />
          This doesn't support primary/foreign or unique constraints which span over multiple columns currently and will only export the first column. Be aware, if you have tables like that!
          <div class="form-group">
            <label for="inputEmail" class="col-sm-5 control-label">Optional additional E-Mails<br /><small>(comma-separated)</small></label>
            <div class="col-sm-5">
              <input type="text" class="form-control" id="inputEmail" name="email" placeholder="me@example.com" value="">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="schema_export_submit">Start</button><%= img '/images/ajax-loader.gif', id: "schema_export_loading", height: '25px', style: 'padding: 0 15px; margin-left: 5px; display: none;' %>
        </div>
      </form>
    </div>
  </div>
</div>

<table id="tablereports" data-auto="true" style="display: none;" class="table table-bordered table-striped table-condensed table-hover">
  <thead>
    <tr>
      <th>Schema</th>
      <th>Table <small class="secondary">(table ID)</small></th>
      <th>Size in GB</th>
      <th>Sort Keys</th>
      <th>Distribution</th>
      <th>Column Encoding</th>
      <th>% Skew Across Slices <small class="secondary">(lower better)</small></th>
      <th>% Slices Populated <small class="secondary">(higher better)</small></th>
      <th class="text-center"></th>
    </tr>
  </thead>
  <tbody>
  <% @tables.each_with_index do |row, i| %>
    <tr>
      <td><%= row['schema_name'] %></td>
      <td><%= row['table_name'] %> <small class="secondary">(<%=row['table_id']%>)</small></td>
      <td nowrap="nowrap"><%= (row['size_in_mb'].to_i / 1024.0).round(2) %></td>
      <td>
        <% if row['sort_keys'].present? %>
          <%= row['sort_keys'].collect{|k|
                "<span class='label label-#{(k == row['sort_keys'].first ? 'primary' : 'info')}'>#{k}</span>"
              }.join('<br />') %>
        <% else %>
          <span class="label label-danger">None!</span>
        <% end %>
      </td>
      <td>
        <% if row['dist_key'].present? %>
          <% if row['dist_key'] == row['sort_keys'].first %>
            <span class='label label-primary'><%= h row['dist_key'] %></span>
          <% else %>
            <span class='label label-default'><%= h row['dist_key'] %></span>
          <% end %>
        <% else %>
          <% if row['dist_style'].present? %>
            <span class='label label-info'><%= h row['dist_style'] %> distribution</span>
          <% else %>
            <span class="label label-danger">unknown distribution</span>
          <% end %>
        <% end %>
        <br />
      </td>
      <td>
        <% if row['has_col_encodings'] %>
          <span class='label label-success'>Yes</span>
        <% else %>
          <span class="label label-danger">No</span>
        <% end %>
      </td>
      <td>
        <span class='label label-<%= row['pct_skew_across_slices'].to_f > 100.0 ? 'danger' : 'success' %>'><%= 
          h row['pct_skew_across_slices'].round(2) %>%</span>
      </td>
      <td>
        <span class='label label-<%= row['pct_slices_populated'].to_f < 50.0 ? 'danger' : 'success' %>'>
      <%= h row['pct_slices_populated'].round(2) %>%</span></td>
      <td class="text-center"><button id="update_button_<%= i %>" type="button" data-id="<%= i %>" data-schema-name="<%= row['schema_name'] %>" data-table-name="<%= row['table_name'] %>" class="tbl-update btn btn-info btn-xs">Update</button><%= img '/images/ajax-loader.gif', id: "loading_img_#{i}", height: '25px', style: 'display: none;' %></td>
    </tr >
  <% end %>
  </tbody>
</table>

<%= js :tables %>
